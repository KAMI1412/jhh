<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Confessions</title>
    <link rel="manifest" href="manifest.json">
    <meta property="og:title" content="Confessional">
    <meta property="og:description"
        content="Forgive me, for I have sinned. An anonymous space for confession and judgment.">
    <meta property="og:image" content="https://miniappp-pi.vercel.app/preview.png">
    <meta property="og:url" content="https://miniappp-pi.vercel.app">
    <meta property="fc:frame" content="vNext">
    <meta property="fc:frame:image" content="https://miniappp-pi.vercel.app/preview.png">
    <meta property="fc:frame:button:1" content="Enter Confessional">
    <meta property="fc:frame:button:1:action" content="link">
    <meta property="fc:frame:button:1:target" content="https://miniappp-pi.vercel.app">
    <meta property="fc:frame:post_url" content="https://miniappp-pi.vercel.app">
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <div class="container">
        <header>
            <h1>CONFESSIONAL</h1>
            <p class="subtitle">"Forgive me, for I have sinned"</p>
        </header>

        <div class="stats-bar">
            <div class="stat">
                <span class="stat-icon">üïØ</span>
                <span class="stat-label">Grace</span>
                <span class="stat-value" id="grace-count">100</span>
            </div>
            <div class="stat">
                <span class="stat-icon">‚ú®</span>
                <span class="stat-label">Faith</span>
                <span class="stat-value" id="faith-count">0</span>
            </div>
            <div class="stat">
                <span class="stat-icon">üëÅ</span>
                <span class="stat-label" id="user-title">Seeker</span>
            </div>
            <div class="stat">
                <span class="stat-icon">üé≠</span>
                <span class="stat-label" id="username-display">Anonymous</span>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" data-tab="judge">Hear Confessions</button>
            <button class="tab" data-tab="confess">Confess</button>
            <button class="tab" data-tab="leaderboard">The Faithful</button>
        </div>

        <div class="navigation-controls">
            <button class="nav-btn" id="prev-btn">‚Üê Previous</button>
            <button class="skip-btn" id="skip-btn">Next ‚Üí</button>
        </div>

        <div class="tab-content active" id="judge-tab">
            <div class="judge-section">
                <div class="deed-card" id="deed-card">
                    <div class="deed-header">
                        <span class="deed-type" id="deed-type">Confession</span>
                        <div class="deed-meta">
                            <span class="deed-user" id="deed-user">Anonymous</span>
                            <span class="deed-id" id="current-deed-id">#XXXXX</span>
                        </div>
                    </div>
                    <p class="deed-text" id="deed-text">Loading...</p>
                    <div class="deed-stats">
                        <span class="deed-stat">üôè <span id="deed-bless-count">0</span></span>
                        <span class="deed-stat">üëé <span id="deed-block-count">0</span></span>
                    </div>

                    <!-- Comments Section -->
                    <div class="comments-section" id="comments-section">
                        <div class="comments-header">Judgments (<span id="comment-count">0</span>)</div>
                        <div class="comments-list" id="comments-list">
                            <!-- Comments will appear here -->
                        </div>
                    </div>
                </div>

                <!-- Add Comment Box -->
                <div class="comment-box">
                    <textarea id="comment-input" placeholder="Speak your judgment... (optional)"
                        maxlength="200"></textarea>
                    <div class="comment-char-count">
                        <span id="comment-char-counter">0</span>/200
                    </div>
                    <button class="submit-judgment-btn" id="submit-judgment-btn" style="display: none;">
                        üí¨ Submit Judgment ($0.20 USDC)
                    </button>
                    <div
                        style="text-align: center; font-size: 0.85em; color: #8B7355; margin-top: 8px; font-style: italic;">
                        Select <strong>Condemn</strong> or <strong>Absolve</strong> below (free, costs Grace only)
                    </div>
                </div>

                <div class="judge-actions">
                    <button class="judge-btn block-btn" id="block-btn">
                        <span class="btn-icon">‚öñ</span>
                        <span class="btn-text">Condemn</span>
                        <span class="btn-cost">+15 Grace</span>
                    </button>
                    <button class="judge-btn bless-btn" id="bless-btn">
                        <span class="btn-icon">üïä</span>
                        <span class="btn-text">Absolve</span>
                        <span class="btn-cost">-5 Grace</span>
                    </button>
                </div>
            </div>
        </div>

        <div class="tab-content" id="confess-tab">
            <div class="write-section">
                <textarea id="confession-input" placeholder="Speak your confession unto the faithful..."
                    maxlength="500"></textarea>
                <div class="char-count">
                    <span id="char-counter">0</span>/500
                </div>
                <div class="confession-cost">
                    <span>Your penance: $0.10 USDC (Base Chain)</span>
                    <span style="display: block; font-size: 0.8em; margin-top: 5px; opacity: 0.8;">Paid through the x402
                        protocol</span>
                </div>
                <button id="submit-btn" class="submit-btn">
                    Confess Your Sins
                </button>
            </div>
        </div>

        <div class="tab-content" id="leaderboard-tab">
            <div class="leaderboard-section">
                <div class="leaderboard-tabs">
                    <button class="lb-tab active" data-lb="faithful">The Righteous</button>
                    <button class="lb-tab" data-lb="merciful">The Merciful</button>
                </div>
                <div class="leaderboard-list" id="leaderboard-list">
                    <!-- Leaderboard entries -->
                </div>
            </div>
        </div>

        <div class="loading-overlay" id="loading-overlay">
            <div class="spinner"></div>
        </div>

        <!-- Username Selection Modal -->
        <div class="username-modal" id="username-modal">
            <div class="username-modal-content">
                <h2>Choose Your Anonymous Identity</h2>
                <p>Select a name to use in the Confessional</p>
                <input type="text" id="username-input" placeholder="Enter anonymous name..." maxlength="20"
                    autocomplete="off" />
                <div class="username-char-count">
                    <span id="username-char-counter">0</span>/20
                </div>
                <button id="username-submit-btn" class="username-submit-btn">
                    Enter the Confessional
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        // Import Firebase
        import { database, ref, push, set, onValue, update, get } from './firebase-config.js';

        // Import wallet dependencies
        let getWalletClient, configWagmi;

        // Dynamically import dependencies
        async function loadDependencies() {
            // No dependencies needed for direct wallet transactions
        }

        // Game State
        let deeds = [];
        let currentDeedIndex = 0;
        let grace = 100;
        let faith = 0;
        let userStats = {
            blessed: 0,
            blocked: 0,
            submitted: 0
        };
        let walletConnected = false;
        let userAddress = null;
        let farcasterUsername = null;

        const STORAGE_KEY = 'bless_or_block_deeds';
        const STATS_KEY = 'bless_or_block_stats';
        const JUDGED_DEEDS_KEY = 'confessional_judged_deeds';
        const USERNAME_KEY = 'confessional_username';
        let sdk = null;
        let anonymousUsername = null;
        let currentlyDisplayedDeed = null; // Track the deed currently being shown
        let judgedDeeds = new Set(); // Track which deeds this user has judged
        let allUsers = []; // Store all users for leaderboard

        // DOM elements
        const confessionInput = document.getElementById('confession-input');
        const charCounter = document.getElementById('char-counter');
        const submitBtn = document.getElementById('submit-btn');
        const loadingOverlay = document.getElementById('loading-overlay');
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');

        // Judge tab elements
        const deedText = document.getElementById('deed-text');
        const deedId = document.getElementById('current-deed-id');
        const deedType = document.getElementById('deed-type');
        const deedBlessCount = document.getElementById('deed-bless-count');
        const deedBlockCount = document.getElementById('deed-block-count');
        const blessBtn = document.getElementById('bless-btn');
        const blockBtn = document.getElementById('block-btn');
        const skipBtn = document.getElementById('skip-btn');
        const prevBtn = document.getElementById('prev-btn');
        const deedUser = document.getElementById('deed-user');
        const commentInput = document.getElementById('comment-input');
        const commentCharCounter = document.getElementById('comment-char-counter');
        const submitJudgmentBtn = document.getElementById('submit-judgment-btn');
        const commentsList = document.getElementById('comments-list');
        const commentCount = document.getElementById('comment-count');

        // Stats elements
        const graceCount = document.getElementById('grace-count');
        const faithCount = document.getElementById('faith-count');
        const userTitle = document.getElementById('user-title');
        const leaderboardList = document.getElementById('leaderboard-list');

        // Username elements
        const usernameModal = document.getElementById('username-modal');
        const usernameInput = document.getElementById('username-input');
        const usernameCharCounter = document.getElementById('username-char-counter');
        const usernameSubmitBtn = document.getElementById('username-submit-btn');
        const usernameDisplay = document.getElementById('username-display');

        // Initialize app
        async function initApp() {
            try {
                showLoading();
                await loadDependencies();
                loadData();
                updateStats();

                try {
                    const module = await import('https://esm.sh/@farcaster/miniapp-sdk');
                    sdk = module.sdk;
                    if (sdk && sdk.actions && sdk.actions.ready) {
                        await sdk.actions.ready();
                    }

                    // Get wallet context and username from Farcaster
                    if (sdk && sdk.wallet) {
                        try {
                            const wallet = await sdk.wallet.ethProvider;
                            if (wallet) {
                                walletConnected = true;
                                const accounts = await wallet.request({ method: 'eth_accounts' });
                                if (accounts && accounts.length > 0) {
                                    userAddress = accounts[0];
                                }
                            }
                        } catch (error) {
                            console.log('Wallet not available:', error);
                        }
                    }

                    // Get Farcaster username
                    if (sdk && sdk.context) {
                        try {
                            const context = await sdk.context;
                            if (context && context.user && context.user.username) {
                                farcasterUsername = context.user.username.toLowerCase();
                                console.log('Farcaster username:', farcasterUsername);
                            }
                        } catch (error) {
                            console.log('Could not get username:', error);
                        }
                    }
                } catch (error) {
                    console.log('Running in standalone mode');
                }

                // Load and check username
                loadUsername();
                if (!anonymousUsername) {
                    showUsernameModal();
                }

                hideLoading();
                loadNextDeed();
            } catch (error) {
                console.error('Failed to initialize app:', error);
                hideLoading();
            }
        }

        // Tab switching
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.getAttribute('data-tab');
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                tabContents.forEach(content => content.classList.remove('active'));
                document.getElementById(`${tabName}-tab`).classList.add('active');

                if (tabName === 'judge') {
                    loadNextDeed();
                } else if (tabName === 'leaderboard') {
                    renderLeaderboard();
                }
            });
        });

        // Character counter for comments
        commentInput.addEventListener('input', () => {
            const length = commentInput.value.length;
            commentCharCounter.textContent = length;
            commentCharCounter.style.color = length > 180 ? '#ff4444' : '#7a7a8a';

            // Show/hide submit judgment button based on text
            if (length > 0) {
                submitJudgmentBtn.style.display = 'block';
            } else {
                submitJudgmentBtn.style.display = 'none';
            }
        });

        // Character counter
        confessionInput.addEventListener('input', () => {
            const length = confessionInput.value.length;
            charCounter.textContent = length;
            charCounter.style.color = length > 450 ? '#ff4444' : '#999';
        });

        // Username functions
        function loadUsername() {
            const saved = localStorage.getItem(USERNAME_KEY);
            if (saved) {
                anonymousUsername = saved;
                updateUsernameDisplay();
            }
        }

        function saveUsername(username) {
            localStorage.setItem(USERNAME_KEY, username);
            anonymousUsername = username;
            updateUsernameDisplay();
        }

        function updateUsernameDisplay() {
            if (usernameDisplay && anonymousUsername) {
                usernameDisplay.textContent = anonymousUsername;
            }
        }

        function showUsernameModal() {
            if (usernameModal) {
                usernameModal.classList.add('active');
                usernameInput.focus();
            }
        }

        function hideUsernameModal() {
            if (usernameModal) {
                usernameModal.classList.remove('active');
            }
        }

        // Username input character counter
        usernameInput.addEventListener('input', () => {
            const length = usernameInput.value.length;
            usernameCharCounter.textContent = length;
            usernameCharCounter.style.color = length > 18 ? '#ff4444' : '#7a7a8a';
        });

        // Username submit
        usernameSubmitBtn.addEventListener('click', () => {
            const username = usernameInput.value.trim();
            if (username.length >= 3) {
                saveUsername(username);
                hideUsernameModal();
            } else {
                alert('Username must be at least 3 characters long');
            }
        });

        // Allow Enter key to submit username
        usernameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                usernameSubmitBtn.click();
            }
        });

        // Submit confession with payment
        submitBtn.addEventListener('click', async () => {
            const text = confessionInput.value.trim();

            if (!text) {
                showMessage('Please write something before submitting!', 'error');
                return;
            }

            if (text.length < 10) {
                showMessage('Too short. Please write at least 10 characters.', 'error');
                return;
            }

            // Check if wallet is connected (Farcaster wallet is auto-connected)
            if (!walletConnected && sdk && sdk.wallet) {
                try {
                    const wallet = await sdk.wallet.ethProvider;
                    if (wallet) {
                        const accounts = await wallet.request({ method: 'eth_accounts' });
                        if (accounts && accounts.length > 0) {
                            walletConnected = true;
                            userAddress = accounts[0];
                        } else {
                            showMessage('Please connect your wallet in Farcaster settings', 'error');
                            return;
                        }
                    }
                } catch (error) {
                    console.error('Wallet error:', error);
                    showMessage('Wallet connection required. Please check Farcaster wallet settings.', 'error');
                    return;
                }
            }

            try {
                showLoading();

                // Process payment using direct wallet transaction
                let paymentSuccessful = false;

                if (sdk && sdk.wallet) {
                    try {
                        // Get wallet provider from Farcaster SDK
                        const provider = await sdk.wallet.ethProvider;

                        if (!provider) {
                            throw new Error('Wallet provider not available');
                        }

                        // Verify we're on Base network (chainId 8453)
                        const chainId = await provider.request({ method: 'eth_chainId' });
                        const baseChainId = '0x2105'; // 8453 in hex

                        if (chainId !== baseChainId) {
                            try {
                                await provider.request({
                                    method: 'wallet_switchEthereumChain',
                                    params: [{ chainId: baseChainId }],
                                });
                            } catch (switchError) {
                                // This error code indicates that the chain has not been added to MetaMask.
                                if (switchError.code === 4902) {
                                    showMessage('Please add Base network to your wallet', 'error');
                                } else {
                                    showMessage('Please switch to Base network in your wallet', 'error');
                                }
                                hideLoading();
                                return;
                            }
                        }

                        // USDC on Base: 0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913
                        const usdcAddress = '0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913';
                        const recipientAddress = '0x4d68BF377995c478bb8D3bB1eDE71502c7E55E94';
                        const paymentAmount = '100000'; // 0.10 USDC (6 decimals)

                        // Encode transfer data
                        const transferData = encodeTransfer(recipientAddress, paymentAmount);

                        // Request payment transaction
                        const tx = await provider.request({
                            method: 'eth_sendTransaction',
                            params: [{
                                from: userAddress,
                                to: usdcAddress,
                                value: '0x0',
                                data: transferData,
                                chainId: baseChainId // Explicitly specify chainId
                            }]
                        });

                        if (tx) {
                            paymentSuccessful = true;
                            await showMessage('‚úì Payment successful! 0.10 USDC paid', 'success');
                        }
                    } catch (paymentError) {
                        console.error('Payment failed:', paymentError);
                        hideLoading();

                        if (paymentError.message && paymentError.message.includes('User denied')) {
                            showMessage('Payment cancelled by user', 'error');
                        } else {
                            showMessage('Payment failed: ' + (paymentError.message || 'Unknown error'), 'error');
                        }
                        return;
                    }
                } else {
                    // Fallback: Use Grace points if payment not available
                    if (grace < 20) {
                        showMessage('Not enough Grace! Bless more deeds to earn Grace.', 'error');
                        hideLoading();
                        return;
                    }
                    grace -= 20;
                    paymentSuccessful = true;
                }

                if (paymentSuccessful) {
                    const deed = {
                        id: generateId(),
                        text: text,
                        timestamp: Date.now(),
                        blessCount: 0,
                        blockCount: 0,
                        type: 'Confession',
                        paid: walletConnected,
                        username: anonymousUsername || 'Anonymous',
                        comments: []
                    };

                    // Save to Firebase
                    await saveDeed(deed);

                    userStats.submitted++;
                    saveData(); // Save personal stats
                    updateStats();

                    confessionInput.value = '';
                    charCounter.textContent = '0';

                    await showMessage('‚úì Deed submitted for judgment!', 'success');

                    tabs[0].click();
                }

                hideLoading();
            } catch (error) {
                console.error('Failed to submit:', error);
                showMessage('Failed to submit. Please try again.', 'error');
                hideLoading();
            }
        });

        // Encode USDC transfer function
        function encodeTransfer(recipientAddress, amount) {
            // ERC20 transfer function signature: transfer(address,uint256)
            const functionSignature = '0xa9059cbb';
            // Remove 0x prefix if present and pad to 64 chars
            const recipient = recipientAddress.replace('0x', '').padStart(64, '0');
            const amountHex = parseInt(amount).toString(16).padStart(64, '0');
            return functionSignature + recipient + amountHex;
        }

        // Bless button (free, no payment required)
        blessBtn.addEventListener('click', async () => {
            if (!currentlyDisplayedDeed) return;

            const deed = currentlyDisplayedDeed;

            // Check if already judged
            if (judgedDeeds.has(deed.id)) {
                showMessage('You have already judged this confession', 'error');
                return;
            }

            deed.blessCount++;
            grace -= 5;  // Lose grace when absolving
            faith += 2;
            userStats.blessed++;

            // Mark as judged
            judgedDeeds.add(deed.id);
            localStorage.setItem(JUDGED_DEEDS_KEY, JSON.stringify([...judgedDeeds]));

            // Update Firebase
            await updateDeed(deed.id, {
                blessCount: deed.blessCount
            });

            saveData(); // Save personal stats
            await saveUserStatsToFirebase(); // Sync to Firebase
            updateStats();

            await showMessage('üïä Absolved! -5 Grace, +2 Faith', 'success');
            loadNextDeed();
        });

        // Block button (free, no payment required)
        blockBtn.addEventListener('click', async () => {
            if (!currentlyDisplayedDeed) return;

            const deed = currentlyDisplayedDeed;

            // Check if already judged
            if (judgedDeeds.has(deed.id)) {
                showMessage('You have already judged this confession', 'error');
                return;
            }

            deed.blockCount++;
            grace += 15;  // Gain more grace when condemning
            faith += 1;  // Also gain faith when condemning
            userStats.blocked++;

            // Mark as judged
            judgedDeeds.add(deed.id);
            localStorage.setItem(JUDGED_DEEDS_KEY, JSON.stringify([...judgedDeeds]));

            // Update Firebase
            await updateDeed(deed.id, {
                blockCount: deed.blockCount
            });

            saveData(); // Save personal stats
            await saveUserStatsToFirebase(); // Sync to Firebase
            updateStats();

            await showMessage('‚öñ Condemned! +15 Grace, +1 Faith', 'warning');
            loadNextDeed();
        });

        // Initial load
        loadNextDeed();

        // Navigation buttons
        skipBtn.addEventListener('click', () => {
            currentDeedIndex++;
            loadNextDeed();
        });

        prevBtn.addEventListener('click', () => {
            currentDeedIndex--;
            loadNextDeed();
        });

        // Submit Judgment button (paid comment)
        submitJudgmentBtn.addEventListener('click', async () => {
            if (!currentlyDisplayedDeed) return;

            const deed = currentlyDisplayedDeed;
            const comment = commentInput.value.trim();

            if (!comment) {
                showMessage('Please write a judgment first', 'error');
                return;
            }

            const isJesus = farcasterUsername === 'jesus';

            if (!isJesus) {
                // Non-jesus users must pay
                if (!walletConnected && sdk && sdk.wallet) {
                    try {
                        const wallet = await sdk.wallet.ethProvider;
                        if (wallet) {
                            const accounts = await wallet.request({ method: 'eth_accounts' });
                            if (accounts && accounts.length > 0) {
                                walletConnected = true;
                                userAddress = accounts[0];
                            } else {
                                showMessage('Wallet required for judgments. Please connect in Farcaster.', 'error');
                                return;
                            }
                        }
                    } catch (error) {
                        showMessage('Wallet connection required for judgments', 'error');
                        return;
                    }
                }

                // Process payment for judgment
                try {
                    showLoading();

                    const provider = await sdk.wallet.ethProvider;
                    if (!provider) {
                        throw new Error('Wallet provider not available');
                    }

                    const chainId = await provider.request({ method: 'eth_chainId' });
                    const baseChainId = '0x2105';

                    if (chainId !== baseChainId) {
                        try {
                            await provider.request({
                                method: 'wallet_switchEthereumChain',
                                params: [{ chainId: baseChainId }],
                            });
                        } catch (switchError) {
                            if (switchError.code === 4902) {
                                showMessage('Please add Base network to your wallet', 'error');
                            } else {
                                showMessage('Please switch to Base network in your wallet', 'error');
                            }
                            hideLoading();
                            return;
                        }
                    }

                    const usdcAddress = '0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913';
                    const recipientAddress = '0x4d68BF377995c478bb8D3bB1eDE71502c7E55E94';
                    const commentPayment = '200000'; // 0.20 USDC

                    const transferData = encodeTransfer(recipientAddress, commentPayment);

                    const tx = await provider.request({
                        method: 'eth_sendTransaction',
                        params: [{
                            from: userAddress,
                            to: usdcAddress,
                            value: '0x0',
                            data: transferData,
                            chainId: baseChainId
                        }]
                    });

                    if (!tx) {
                        hideLoading();
                        showMessage('Payment cancelled', 'error');
                        return;
                    }

                    hideLoading();
                } catch (paymentError) {
                    console.error('Payment failed:', paymentError);
                    hideLoading();

                    if (paymentError.message && paymentError.message.includes('User denied')) {
                        showMessage('Payment cancelled. Judgment not posted.', 'error');
                    } else {
                        showMessage('Payment failed: ' + (paymentError.message || 'Unknown error'), 'error');
                    }
                    return;
                }
            }

            // Add comment to the deed
            if (!deed.comments) deed.comments = [];
            deed.comments.push({
                text: comment,
                judgment: 'neutral',
                timestamp: Date.now()
            });

            // Update Firebase with new comment
            await updateDeed(deed.id, {
                comments: deed.comments
            });

            await showMessage('üí¨ Judgment posted! (0.20 USDC paid)', 'success');

            commentInput.value = '';
            commentCharCounter.textContent = '0';
            submitJudgmentBtn.style.display = 'none';

            loadNextDeed();
        });

        // Load next deed
        function loadNextDeed() {
            if (deeds.length === 0) {
                deedText.innerHTML = '<div style="text-align: center">The confessional is empty.<br><br><span style="font-size: 0.8em; color: #8B7355">Be the first to confess your sins!</span></div>';
                deedId.textContent = '#EMPTY';
                deedType.textContent = 'Waiting';
                deedBlessCount.textContent = '0';
                deedBlockCount.textContent = '0';
                commentsList.innerHTML = '';
                commentCount.textContent = '0';
                blessBtn.disabled = true;
                blockBtn.disabled = true;
                // Add visual style to disabled buttons
                blessBtn.style.opacity = '0.3';
                blockBtn.style.opacity = '0.3';
                return;
            }

            // Reset button styles
            blessBtn.style.opacity = '1';
            blockBtn.style.opacity = '1';

            // Handle index wrapping
            if (currentDeedIndex >= deeds.length) currentDeedIndex = 0;
            if (currentDeedIndex < 0) currentDeedIndex = deeds.length - 1;

            const deed = deeds[currentDeedIndex];
            currentlyDisplayedDeed = deed; // Store reference to displayed deed

            deedText.textContent = deed.text;
            deedId.textContent = '#' + deed.id;
            deedType.textContent = deed.type || 'Confession';
            deedBlessCount.textContent = deed.blessCount || 0;
            deedBlockCount.textContent = deed.blockCount || 0;

            if (deedUser) {
                deedUser.textContent = deed.username || 'Anonymous';
            }

            // Check if user has already judged this deed
            if (judgedDeeds.has(deed.id)) {
                blessBtn.disabled = true;
                blockBtn.disabled = true;
                blessBtn.style.opacity = '0.3';
                blockBtn.style.opacity = '0.3';
            } else {
                blessBtn.disabled = false;
                blockBtn.disabled = false;
                blessBtn.style.opacity = '1';
                blockBtn.style.opacity = '1';
            }

            // Render comments
            renderComments(deed.comments || []);
        }

        // Render comments for current deed
        function renderComments(comments) {
            commentCount.textContent = comments.length;

            if (comments.length === 0) {
                commentsList.innerHTML = '<div style="text-align: center; color: #7a7a8a; padding: 10px; font-size: 0.85em;">No judgments yet</div>';
                return;
            }

            commentsList.innerHTML = comments.map(comment => `
                <div class="comment-item ${comment.judgment}">
                    <div class="comment-header">
                        <span class="comment-judgment ${comment.judgment}">
                            ${comment.judgment === 'blessed' ? 'üôè Blessed' : 'üëé Blocked'}
                        </span>
                        <span class="comment-time">${formatTime(comment.timestamp)}</span>
                    </div>
                    <div class="comment-text">${escapeHtml(comment.text)}</div>
                </div>
            `).join('');
        }

        // Format time helper
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;

            // If less than 24 hours
            if (diff < 24 * 60 * 60 * 1000) {
                if (diff < 60 * 60 * 1000) {
                    const minutes = Math.floor(diff / (60 * 1000));
                    return `${minutes}m ago`;
                }
                const hours = Math.floor(diff / (60 * 60 * 1000));
                return `${hours}h ago`;
            }

            return date.toLocaleDateString();
        }

        // Escape HTML helper
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Update stats display
        function updateStats() {
            graceCount.textContent = grace;
            faithCount.textContent = faith;

            const title = getTitleByFaith(faith);
            userTitle.textContent = title;
        }

        // Get title based on faith
        function getTitleByFaith(faith) {
            if (faith >= 1000) return 'üëë Saint';
            if (faith >= 500) return '‚ú® Prophet';
            if (faith >= 250) return 'üïä Priest';
            if (faith >= 100) return 'üôè Believer';
            if (faith >= 50) return 'üå± Novice';
            if (faith < 0) return 'üëø Heretic';
            return 'üîç Seeker';
        }

        // Leaderboard tabs
        document.querySelectorAll('.lb-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.lb-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                renderLeaderboard(tab.getAttribute('data-lb'));
            });
        });

        // Render leaderboard
        function renderLeaderboard(type = 'faithful') {
            if (allUsers.length === 0) {
                leaderboardList.innerHTML = '<div style="text-align: center; color: #7a7a8a; padding: 20px;">No users yet. Be the first to judge!</div>';
                return;
            }

            // Sort based on leaderboard type
            let sortedUsers = [...allUsers];
            if (type === 'merciful') {
                // Sort by blessed count (most merciful)
                sortedUsers.sort((a, b) => (b.blessed || 0) - (a.blessed || 0));
            } else {
                // Sort by faith (most righteous)
                sortedUsers.sort((a, b) => (b.faith || 0) - (a.faith || 0));
            }

            leaderboardList.innerHTML = sortedUsers.map((user, index) => {
                const actualRank = index + 1;
                const rankClass = actualRank === 1 ? 'first' : actualRank === 2 ? 'second' : actualRank === 3 ? 'third' : '';
                const isYou = user.username === anonymousUsername;
                const youClass = isYou ? 'style="background: rgba(212, 175, 55, 0.1); border-color: rgba(212, 175, 55, 0.4);"' : '';
                const score = type === 'merciful' ? (user.blessed || 0) : (user.faith || 0);
                const scoreLabel = type === 'merciful' ? 'Absolved' : 'Faith';

                return `
                    <div class="lb-entry" ${youClass}>
                        <div class="lb-rank ${rankClass}">#${actualRank}</div>
                        <div class="lb-info">
                            <div class="lb-name">${user.username}${isYou ? ' üéØ' : ''}</div>
                            <div class="lb-title">${user.title || getTitleByFaith(user.faith || 0)}</div>
                        </div>
                        <div class="lb-score">${score} ${scoreLabel}</div>
                    </div>
                `;
            }).join('');
        }

        // Data persistence - Load from Firebase
        function loadData() {
            try {
                // Load personal stats from localStorage (Grace, Faith, etc)
                const storedStats = localStorage.getItem(STATS_KEY);
                const storedJudged = localStorage.getItem(JUDGED_DEEDS_KEY);

                if (storedStats) {
                    const stats = JSON.parse(storedStats);
                    grace = stats.grace || 100;
                    faith = stats.faith || 0;
                    userStats = stats.userStats || { blessed: 0, blocked: 0, submitted: 0 };
                }

                if (storedJudged) {
                    judgedDeeds = new Set(JSON.parse(storedJudged));
                }

                // Load confessions from Firebase with real-time sync
                const confessionsRef = ref(database, 'confessions');
                onValue(confessionsRef, (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        // Convert Firebase object to array
                        deeds = Object.values(data).sort((a, b) => b.timestamp - a.timestamp);
                    } else {
                        deeds = [];
                    }

                    // Update UI after loading
                    if (currentDeedIndex === 0 && deeds.length > 0) {
                        loadNextDeed();
                    }
                    updateStats();
                });

                // Load all users for leaderboard with real-time sync
                const usersRef = ref(database, 'users');
                onValue(usersRef, (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        allUsers = Object.values(data);
                    } else {
                        allUsers = [];
                    }
                });
            } catch (error) {
                console.error('Failed to load data:', error);
            }
        }

        async function saveData() {
            try {
                // Save personal stats to localStorage
                localStorage.setItem(STATS_KEY, JSON.stringify({
                    grace,
                    faith,
                    userStats
                }));

                // Confessions are automatically synced via Firebase real-time listeners
                // No need to manually save - updates happen through saveDeed() function
            } catch (error) {
                console.error('Failed to save data:', error);
            }
        }

        // New function to save individual deed to Firebase
        async function saveDeed(deed) {
            try {
                const confessionsRef = ref(database, `confessions/${deed.id}`);
                await set(confessionsRef, deed);
            } catch (error) {
                console.error('Failed to save deed to Firebase:', error);
                throw error;
            }
        }

        // New function to update deed (for votes/comments)
        async function updateDeed(deedId, updates) {
            try {
                const deedRef = ref(database, `confessions/${deedId}`);
                await update(deedRef, updates);
            } catch (error) {
                console.error('Failed to update deed:', error);
                throw error;
            }
        }

        // Save user stats to Firebase
        async function saveUserStatsToFirebase() {
            if (!anonymousUsername) return;

            try {
                const userRef = ref(database, `users/${anonymousUsername}`);
                await set(userRef, {
                    username: anonymousUsername,
                    faith: faith,
                    grace: grace,
                    blessed: userStats.blessed,
                    blocked: userStats.blocked,
                    submitted: userStats.submitted,
                    title: getTitleByFaith(faith),
                    lastUpdated: Date.now()
                });
            } catch (error) {
                console.error('Failed to save user stats to Firebase:', error);
            }
        }

        // Utility functions
        function generateId() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }

        function showMessage(text, type = 'success') {
            return new Promise(resolve => {
                const colors = {
                    success: '#4caf50',
                    error: '#dc3545',
                    warning: '#ff9800'
                };

                const message = document.createElement('div');
                message.style.cssText = `
                            position: fixed;
                            top: 20px;
                            left: 50%;
                            transform: translateX(-50%);
                            background: ${colors[type]};
                            color: white;
                            padding: 15px 30px;
                            border-radius: 10px;
                            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
                            z-index: 2000;
                            animation: slideDown 0.3s ease;
                            `;
                message.textContent = text;

                document.body.appendChild(message);

                setTimeout(() => {
                    message.style.animation = 'slideUp 0.3s ease';
                    setTimeout(() => {
                        document.body.removeChild(message);
                        resolve();
                    }, 300);
                }, 2000);
            });
        }

        function showLoading() {
            loadingOverlay.classList.add('active');
        }

        function hideLoading() {
            loadingOverlay.classList.remove('active');
        }

        // Add CSS animations
        const style = document.createElement('style');
        style.textContent = `
                            @keyframes slideDown {
                from {
                                    opacity: 0;
                                    transform: translateX(-50%) translateY(-20px);
                                }
                to {
                                    opacity: 1;
                                    transform: translateX(-50%) translateY(0);
                                }
                            }

                            @keyframes slideUp {
                from {
                                    opacity: 1;
                                    transform: translateX(-50%) translateY(0);
                                }
                to {
                                    opacity: 0;
                                    transform: translateX(-50%) translateY(-20px);
                                }
                            }
        `;
        document.head.appendChild(style);

        // Initialize app
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            initApp();
        }
    </script>
</body>

</html>